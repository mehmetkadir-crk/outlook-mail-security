<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mail G√ºvenlik Analizi</title>
    
    <!-- Office.js - Multiple CDN fallbacks -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" 
            onerror="loadOfficeFallback()"></script>
    
    <script>
        // Office.js fallback loading
        let officeFallbackLoaded = false;
        
        function loadOfficeFallback() {
            if (officeFallbackLoaded) return;
            officeFallbackLoaded = true;
            
            console.log('Primary Office.js failed, trying fallback...');
            
            // Try alternative CDN
            const fallbackScript = document.createElement('script');
            fallbackScript.src = 'https://res.cdn.office.net/scripts/office-1.1.js';
            fallbackScript.onerror = function() {
                console.log('All Office.js CDNs failed, running in demo mode');
                // Force demo mode after 2 seconds
                setTimeout(() => {
                    if (typeof Office === 'undefined') {
                        initializeDemoMode();
                    }
                }, 2000);
            };
            document.head.appendChild(fallbackScript);
        }
        
        // Initialize demo mode if Office.js completely fails
        function initializeDemoMode() {
            console.log('Forcing demo mode due to Office.js failure');
            window.isOfficeReady = false;
            window.isOutlookHost = false;
            
            // Enable demo button immediately
            const btn = document.querySelector('.analyze-btn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üß™ Demo Mode - Office.js Y√ºklenemedi';
                
                // Add warning
                addDemoWarning();
            }
        }
        
        function addDemoWarning() {
            const container = document.querySelector('.container');
            if (container && !container.querySelector('.demo-warning')) {
                const warning = document.createElement('div');
                warning.className = 'demo-warning';
                warning.innerHTML = `
                    <div style="background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                        <h3 style="margin: 0 0 10px 0; font-size: 16px;">‚ö†Ô∏è OFFICE.JS Y√úKLENEMEDƒ∞</h3>
                        <p style="margin: 0; font-size: 14px;">
                            ƒ∞nternet baƒülantƒ±sƒ± veya g√ºvenlik duvarƒ± sorunu olabilir<br>
                            <small>Demo mode ile devam edebilirsiniz</small>
                        </p>
                    </div>
                `;
                container.insertBefore(warning, container.children[1]);
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 300;
        }

        .analyze-btn {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .analyze-btn:disabled {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            display: none;
        }

        .risk-score {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #a8edea 0%, #fed6e3 100%);
        }

        .risk-low { 
            background: linear-gradient(45deg, #a8edea 0%, #d299c2 100%);
            color: #27ae60;
        }
        
        .risk-medium { 
            background: linear-gradient(45deg, #ffecd2 0%, #fcb69f 100%);
            color: #f39c12;
        }
        
        .risk-high { 
            background: linear-gradient(45deg, #ff9a9e 0%, #fecfef 100%);
            color: #e74c3c;
        }

        .section {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }

        .section h3 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 18px;
        }

        .auth-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .auth-item {
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            font-weight: bold;
            font-size: 12px;
        }

        .auth-pass { background: #2ecc71; color: white; }
        .auth-fail { background: #e74c3c; color: white; }
        .auth-none { background: #95a5a6; color: white; }

        .url-item, .attachment-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #34495e;
        }

        .threat-detected {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .threat-clean {
            border-left-color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
        }

        .threat-score {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .risk-factors {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
        }

        .risk-factors ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .risk-factors li {
            margin: 5px 0;
            color: #c0392b;
        }

        .no-risks {
            background: rgba(39, 174, 96, 0.1);
            border-left-color: #27ae60;
            text-align: center;
            color: #27ae60;
            font-weight: bold;
        }

        .error {
            background: rgba(231, 76, 60, 0.1);
            border-left-color: #e74c3c;
            color: #c0392b;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üìß Mail G√ºvenlik Analizi</h1>
        
        <button class="analyze-btn" onclick="analyzeEmail()" disabled>
            ‚è≥ Office.js Y√ºkleniyor...
        </button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Mail analiz ediliyor...</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <p id="progressText">Ba≈ülatƒ±lƒ±yor...</p>
        </div>

        <div class="results" id="results">
            <div class="risk-score" id="riskScore">
                üõ°Ô∏è Risk Skoru: <span id="scoreValue">0</span>
            </div>

            <div class="section">
                <h3>üîê E-posta G√ºvenlik Doƒürulamasƒ±</h3>
                <div class="auth-status" id="authStatus">
                </div>
            </div>

            <div class="section" id="urlSection">
                <h3>üîó Bulunan URL'ler ve Domainler</h3>
                <div id="urlResults"></div>
            </div>

            <div class="section" id="attachmentSection">
                <h3>üìé Ekler</h3>
                <div id="attachmentResults"></div>
            </div>

            <div class="section" id="riskFactorsSection">
                <h3>‚ö†Ô∏è Risk Fakt√∂rleri</h3>
                <div id="riskFactors"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            VIRUSTOTAL_API_KEY: '8ed497100d9ad8fd2d2a5ec4a72d3d6f0acde0355502648bb07fb62527d13e54',
            HYBRID_ANALYSIS_API_KEY: 'knxbbjd7007c5eddnn0ql6dd2e20d67e2rslfin6ff49216buscx1slv9074292d'
        };

        let analysisResults = {};
        let isOfficeReady = false;
        let isOutlookHost = false;
        let initializationAttempts = 0;
        const maxInitAttempts = 5;

        // Office.js y√ºklenmesini bekle - daha g√ºvenli versiyon
        function initializeApp() {
            initializationAttempts++;
            console.log(`Initialization attempt ${initializationAttempts}/${maxInitAttempts}`);
            
            if (typeof Office !== 'undefined' && Office.onReady) {
                try {
                    Office.onReady((info) => {
                        console.log('Office.onReady called successfully');
                        isOfficeReady = true;
                        
                        if (info && info.host === Office.HostType.Outlook) {
                            isOutlookHost = true;
                            console.log('Outlook host detected - Real mode enabled');
                            enableRealMode();
                        } else {
                            console.log('Non-Outlook host or no host info - Demo mode enabled');
                            enableDemoMode();
                        }
                    }).catch(error => {
                        console.error('Office.onReady error:', error);
                        enableDemoMode();
                    });
                } catch (error) {
                    console.error('Office.onReady try-catch error:', error);
                    enableDemoMode();
                }
            } else {
                console.log(`Office not ready yet (attempt ${initializationAttempts})`);
                
                if (initializationAttempts < maxInitAttempts) {
                    // Try again in 2 seconds
                    setTimeout(initializeApp, 2000);
                } else {
                    console.log('Max initialization attempts reached - forcing demo mode');
                    enableDemoMode();
                }
            }
        }
        
        function enableRealMode() {
            const btn = document.querySelector('.analyze-btn');
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'üìä E-postayƒ± Analiz Et';
            }
            console.log('Real Outlook mode enabled');
        }

        function enableDemoMode() {
            isOfficeReady = false;
            isOutlookHost = false;
            document.querySelector('.analyze-btn').disabled = false;
            document.querySelector('.analyze-btn').textContent = 'üß™ Demo Phishing Analizi';
            
            // Demo mode uyarƒ±sƒ± ekle
            const container = document.querySelector('.container');
            const warning = document.createElement('div');
            warning.innerHTML = `
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px;">üß™ DEMO MODE</h3>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">
                        Ger√ßek phishing e-postasƒ± √∂rneƒüi ile test ediliyor<br>
                        <small>Outlook i√ßinde √ßalƒ±≈ütƒ±rdƒ±ƒüƒ±nƒ±zda ger√ßek e-postalarƒ±nƒ±zƒ± analiz edecek</small>
                    </p>
                </div>
            `;
            container.insertBefore(warning, container.children[1]);
        }

        // Sayfa y√ºklenme event'lerini daha g√ºvenli handle et
        let pageLoadHandled = false;
        
        function handlePageLoad() {
            if (pageLoadHandled) return;
            pageLoadHandled = true;
            
            console.log('Page loaded, starting initialization...');
            
            // ƒ∞lk deneme hemen
            setTimeout(initializeApp, 500);
            
            // G√ºvenlik i√ßin 5 saniye sonra demo mode'a ge√ß
            setTimeout(() => {
                if (!isOfficeReady && !isOutlookHost) {
                    console.log('Fallback: Enabling demo mode after 5 seconds');
                    enableDemoMode();
                }
            }, 5000);
        }
        
        // Multiple event listeners for better compatibility
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', handlePageLoad);
            window.addEventListener('load', handlePageLoad);
        } else {
            // Page already loaded
            handlePageLoad();
        }

        function showLoading(show = true) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('results').style.display = show ? 'none' : 'block';
            document.querySelector('.analyze-btn').disabled = show;
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        async function analyzeEmail() {
            showLoading(true);
            updateProgress(0, 'E-posta bilgileri alƒ±nƒ±yor...');

            try {
                let emailData, bodyContent, attachments;

                if (isOfficeReady && isOutlookHost) {
                    // Ger√ßek Outlook analizi
                    const item = Office.context.mailbox.item;
                    
                    updateProgress(10, 'E-posta ba≈ülƒ±klarƒ± analiz ediliyor...');
                    
                    emailData = {
                        subject: item.subject,
                        sender: item.from ? item.from.emailAddress : 'Unknown',
                        to: item.to ? item.to.map(t => t.emailAddress).join(', ') : '',
                        internetHeaders: {}
                    };

                    updateProgress(20, 'E-posta i√ßeriƒüi alƒ±nƒ±yor...');
                    bodyContent = await getEmailBody();
                    
                    updateProgress(30, 'Ekler kontrol ediliyor...');
                    attachments = await getAttachments();
                } else {
                    // Demo mode - ger√ßek phishing √∂rneƒüi
                    updateProgress(10, 'Demo phishing e-postasƒ± hazƒ±rlanƒ±yor...');
                    
                    emailData = {
                        subject: 'üö® URGENT: Your Microsoft Account Has Been Compromised!',
                        sender: 'security-team@microsofft-security.com', // Typo kasƒ±tlƒ±
                        to: 'user@company.com',
                        internetHeaders: {},
                        replyTo: 'noreply@suspicious-domain.ru' // Farklƒ± reply-to
                    };

                    updateProgress(20, 'Demo tehlikeli i√ßerik olu≈üturuluyor...');
                    bodyContent = `
                        <html><body style="font-family: Arial;">
                            <div style="background: #0078d4; color: white; padding: 20px; text-align: center;">
                                <h2>üîí Microsoft Security Alert</h2>
                            </div>
                            <div style="padding: 20px;">
                                <p><strong>IMMEDIATE ACTION REQUIRED</strong></p>
                                <p>We detected suspicious activity on your Microsoft account from IP: 192.168.1.100 (Russia)</p>
                                <p>Your account will be <strong style="color: red;">permanently disabled</strong> in 24 hours unless you verify your identity.</p>
                                
                                <div style="background: #fffacd; padding: 15px; border-left: 4px solid #ff6b6b;">
                                    <p><strong>Detected Activities:</strong></p>
                                    <ul>
                                        <li>Unauthorized login attempt from Moscow, Russia</li>
                                        <li>Password change request</li>
                                        <li>Credit card information accessed</li>
                                    </ul>
                                </div>
                                
                                <p style="text-align: center; margin: 30px 0;">
                                    <a href="http://microsofft-security-verification.tk/urgent-verify?user=victim@company.com" 
                                       style="background: #ff4757; color: white; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-weight: bold;">
                                        üîê VERIFY ACCOUNT NOW
                                    </a>
                                </p>
                                
                                <p>Alternative link: <a href="https://phishing-site-example.com/microsoft-login">https://account-verification-urgent.microsoft-security.com</a></p>
                                
                                <p style="font-size: 12px; color: #666;">
                                    This is an automated message from Microsoft Security Team.<br>
                                    Please do not reply to this email.<br>
                                    If you did not request this, please ignore this message.
                                </p>
                                
                                <div style="background: #f8f9fa; padding: 10px; margin-top: 20px; text-align: center;">
                                    <p style="margin: 0; font-size: 10px; color: #999;">
                                        Microsoft Corporation | One Microsoft Way | Redmond, WA 98052
                                    </p>
                                </div>
                            </div>
                        </body></html>
                    `;
                    
                    updateProgress(30, 'Demo zararlƒ± ekler olu≈üturuluyor...');
                    attachments = [
                        { name: 'Microsoft_Security_Update.exe', size: 1547000, attachmentType: 'file' },
                        { name: 'Account_Verification_Form.docm', size: 890000, attachmentType: 'file' },
                        { name: 'Security_Report.pdf.exe', size: 2100000, attachmentType: 'file' }
                    ];
                }

                const links = extractLinksFromContent(bodyContent);

                updateProgress(40, 'URL\'ler VirusTotal ile kontrol ediliyor...');
                const urlResults = await analyzeUrls(links);

                updateProgress(60, 'Ekler analiz ediliyor...');
                const attachmentResults = await analyzeAttachments(attachments);

                updateProgress(80, 'Risk skoru hesaplanƒ±yor...');
                const riskScore = calculateRiskScore(emailData, urlResults, attachmentResults);

                updateProgress(100, 'Analiz tamamlandƒ±!');

                analysisResults = {
                    emailData,
                    links,
                    attachments,
                    urlResults,
                    attachmentResults,
                    riskScore
                };

                setTimeout(() => {
                    displayResults();
                    showLoading(false);
                }, 500);

            } catch (error) {
                console.error('Analysis error:', error);
                showError('Analiz sƒ±rasƒ±nda bir hata olu≈ütu: ' + error.message);
                showLoading(false);
            }
        }

        function getEmailBody() {
            return new Promise((resolve) => {
                if (isOfficeReady && isOutlookHost) {
                    Office.context.mailbox.item.body.getAsync(Office.CoercionType.Html, (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            resolve(result.value);
                        } else {
                            resolve('');
                        }
                    });
                } else {
                    // Demo mode i√ßin √∂rnek HTML content
                    resolve(`
                        <html><body>
                            <p>Demo e-posta i√ßeriƒüi</p>
                            <a href="http://suspicious-site.com">≈û√ºpheli baƒülantƒ±</a>
                        </body></html>
                    `);
                }
            });
        }

        function getAttachments() {
            return new Promise((resolve) => {
                if (isOfficeReady && isOutlookHost) {
                    const item = Office.context.mailbox.item;
                    if (item.attachments && item.attachments.length > 0) {
                        resolve(item.attachments.map(att => ({
                            name: att.name,
                            size: att.size,
                            attachmentType: att.attachmentType
                        })));
                    } else {
                        resolve([]);
                    }
                } else {
                    // Demo mode i√ßin √∂rnek attachments
                    resolve([]);
                }
            });
        }

        function extractLinksFromContent(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            const links = [];
            const anchors = tempDiv.querySelectorAll('a[href]');
            
            anchors.forEach(anchor => {
                const href = anchor.getAttribute('href');
                if (href && !links.includes(href)) {
                    links.push(href);
                }
            });

            // URL pattern ile text i√ßindeki linkleri de bul
            const urlPattern = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/g;
            const textContent = tempDiv.textContent || tempDiv.innerText || '';
            const matches = textContent.match(urlPattern);
            
            if (matches) {
                matches.forEach(match => {
                    if (!links.includes(match)) {
                        links.push(match);
                    }
                });
            }

            return links;
        }

        async function analyzeUrls(urls) {
            const results = [];
            
            for (let url of urls.slice(0, 10)) { // ƒ∞lk 10 URL'yi analiz et
                try {
                    const vtResult = await checkUrlWithVirusTotal(url);
                    const haResult = await checkUrlWithHybridAnalysis(url);
                    
                    results.push({
                        url,
                        virusTotal: vtResult,
                        hybridAnalysis: haResult,
                        riskLevel: calculateUrlRisk(vtResult, haResult)
                    });
                    
                    await delay(1000); // API rate limiting
                } catch (error) {
                    console.error(`Error analyzing URL ${url}:`, error);
                    results.push({
                        url,
                        error: error.message,
                        riskLevel: 'unknown'
                    });
                }
            }
            
            return results;
        }

        async function checkUrlWithVirusTotal(url) {
            // CORS sorunu nedeniyle ger√ßek API √ßaƒürƒ±sƒ± yapamƒ±yoruz
            // Production'da backend proxy kullanƒ±lmalƒ±
            
            if (!isOutlookHost) {
                // Demo mode - daha akƒ±llƒ± sim√ºlasyon
                await delay(800); // API gecikmesini sim√ºle et
                
                let positives = 0;
                const suspicious_indicators = [
                    'phishing', 'malware', 'suspicious', 'fake', 'scam',
                    'microsofft', 'gmai1', 'yah00', 'urgentverify',
                    '.tk', '.ml', 'verification-urgent', 'account-security'
                ];
                
                // URL'de ≈ü√ºpheli kelime sayƒ±sƒ±nƒ± hesapla
                const suspiciousCount = suspicious_indicators.filter(indicator => 
                    url.toLowerCase().includes(indicator.toLowerCase())
                ).length;
                
                if (suspiciousCount >= 2) {
                    positives = Math.min(15 + suspiciousCount * 3, 45); // √áok y√ºksek risk
                } else if (suspiciousCount >= 1) {
                    positives = Math.min(5 + suspiciousCount * 2, 15); // Orta risk
                } else if (url.startsWith('http://')) {
                    positives = 2; // HTTP kullanƒ±mƒ±
                }
                
                return {
                    positives: positives,
                    total: 65,
                    permalink: `https://virustotal.com/gui/url/${btoa(url)}/detection`,
                    scan_date: new Date().toISOString(),
                    note: positives > 0 ? 'Demo: Tehlikeli URL tespit edildi' : 'Demo: Temiz URL'
                };
            }

            const apiUrl = `https://www.virustotal.com/vtapi/v2/url/report`;
            const params = new URLSearchParams({
                apikey: CONFIG.VIRUSTOTAL_API_KEY,
                resource: url
            });

            try {
                console.log(`Checking URL with VirusTotal: ${url}`);
                
                // CORS proxy kullanmaya √ßalƒ±≈ü
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`${apiUrl}?${params}`)}`;
                const response = await fetch(proxyUrl);
                const data = await response.json();
                
                if (data.contents) {
                    const result = JSON.parse(data.contents);
                    return {
                        positives: result.positives || 0,
                        total: result.total || 0,
                        permalink: result.permalink,
                        scan_date: result.scan_date
                    };
                } else {
                    throw new Error('CORS proxy failed');
                }
            } catch (error) {
                console.error('VirusTotal API error:', error);
                // Fallback to simulated results
                const isSuspicious = url.includes('suspicious') || url.includes('malware') || url.includes('phishing');
                return {
                    positives: isSuspicious ? 3 : 0,
                    total: 65,
                    permalink: 'https://virustotal.com/error',
                    scan_date: new Date().toISOString(),
                    note: 'Simulated result due to CORS'
                };
            }
        }

        async function checkUrlWithHybridAnalysis(url) {
            // Hybrid Analysis API i√ßin domain analizi
            try {
                const domain = new URL(url).hostname;
                
                if (!isOutlookHost) {
                    // Demo mode - sim√ºle edilmi≈ü sonu√ßlar
                    await delay(300);
                    const isSuspicious = domain.includes('suspicious') || domain.includes('fake') || domain.includes('malware');
                    return {
                        verdict: isSuspicious ? 'malicious' : 'no-specific-threat',
                        threat_score: isSuspicious ? 80 : 10,
                        note: 'Demo result'
                    };
                }

                // Production'da ger√ßek API √ßaƒürƒ±sƒ± yapƒ±lacak
                // ≈ûu anda demo sonu√ß d√∂nd√ºr√ºyoruz
                return {
                    verdict: 'no-specific-threat',
                    threat_score: 0,
                    note: 'Real API integration needed'
                };
            } catch (error) {
                return { 
                    error: 'Invalid URL',
                    verdict: 'unknown',
                    threat_score: 0
                };
            }
        }

        async function analyzeAttachments(attachments) {
            const results = [];
            
            for (let attachment of attachments) {
                const riskLevel = assessAttachmentRisk(attachment);
                results.push({
                    ...attachment,
                    riskLevel,
                    analysis: 'Static analysis based on file extension and type'
                });
            }
            
            return results;
        }

        function assessAttachmentRisk(attachment) {
            const dangerousExtensions = ['.exe', '.bat', '.cmd', '.scr', '.vbs', '.js', '.jar', '.com', '.pif'];
            const suspiciousExtensions = ['.zip', '.rar', '.7z', '.doc', '.docx', '.xls', '.xlsx', '.pdf'];
            
            const fileName = attachment.name.toLowerCase();
            
            if (dangerousExtensions.some(ext => fileName.endsWith(ext))) {
                return 'high';
            } else if (suspiciousExtensions.some(ext => fileName.endsWith(ext))) {
                return 'medium';
            } else {
                return 'low';
            }
        }

        function calculateUrlRisk(vtResult, haResult) {
            if (vtResult.error || haResult.error) return 'unknown';
            
            const vtPositives = vtResult.positives || 0;
            const vtTotal = vtResult.total || 0;
            
            if (vtPositives > 5) return 'high';
            if (vtPositives > 0) return 'medium';
            return 'low';
        }

        function calculateRiskScore(emailData, urlResults, attachmentResults) {
            let score = 0;
            const factors = [];

            // URL risk skorlarƒ±
            urlResults.forEach(result => {
                if (result.virusTotal && result.virusTotal.positives) {
                    score += result.virusTotal.positives * 2;
                    factors.push(`üö® Tehlikeli URL tespit edildi: ${result.url.substring(0, 50)}...`);
                }
            });

            // Attachment risk skorlarƒ±
            attachmentResults.forEach(att => {
                if (att.riskLevel === 'high') {
                    score += 10;
                    factors.push(`‚ö†Ô∏è Y√ºksek riskli ek: ${att.name}`);
                } else if (att.riskLevel === 'medium') {
                    score += 3;
                    factors.push(`üî∂ Orta riskli ek: ${att.name}`);
                }
            });

            // E-posta ba≈ülƒ±k kontrolleri
            if (emailData.sender && (emailData.sender.includes('noreply') || emailData.sender.includes('donotreply'))) {
                score += 1;
                factors.push('üìß Otomatik g√∂nderici adresi kullanƒ±lmƒ±≈ü');
            }

            // Phishing g√∂stergeleri
            if (emailData.subject && emailData.subject.toLowerCase().includes('urgent')) {
                score += 3;
                factors.push('üö® Acil eylem gerektiren ba≈ülƒ±k');
            }

            if (emailData.subject && (emailData.subject.includes('!') || emailData.subject.includes('üö®'))) {
                score += 2;
                factors.push('‚ö° Panik yaratmaya y√∂nelik ba≈ülƒ±k');
            }

            // G√∂nderici domain kontrol√º
            if (emailData.sender) {
                const senderDomain = emailData.sender.split('@')[1] || '';
                
                // Typosquatting kontrol√º (Microsoft -> Microsofft)
                if (senderDomain.includes('microsofft') || senderDomain.includes('micr0soft') || 
                    senderDomain.includes('gmai1.com') || senderDomain.includes('yah00.com')) {
                    score += 8;
                    factors.push('üé≠ Typosquatting: Sahte domain kullanƒ±mƒ±');
                }

                // ≈û√ºpheli TLD'ler
                if (senderDomain.endsWith('.tk') || senderDomain.endsWith('.ml') || 
                    senderDomain.endsWith('.ru') || senderDomain.endsWith('.cn')) {
                    score += 4;
                    factors.push('üåç ≈û√ºpheli √ºlke domain uzantƒ±sƒ±');
                }
            }

            // Reply-To farklƒ±lƒ±ƒüƒ±
            if (emailData.replyTo && emailData.sender && emailData.replyTo !== emailData.sender) {
                score += 5;
                factors.push('‚Ü©Ô∏è Reply-To adresi g√∂nderici adresinden farklƒ±');
            }

            // Tehdit i√ßeriƒüi analizi
            if (emailData.subject && emailData.subject.toLowerCase().includes('compromised')) {
                score += 4;
                factors.push('üîí Hesap g√ºvenliƒüi tehdidi i√ßeriƒüi');
            }

            return {
                score,
                level: score > 20 ? 'high' : score > 8 ? 'medium' : 'low',
                factors
            };
        }

        function displayResults() {
            const { emailData, urlResults, attachmentResults, riskScore } = analysisResults;

            // Risk skoru g√∂ster
            const scoreElement = document.getElementById('scoreValue');
            const riskScoreDiv = document.getElementById('riskScore');
            
            scoreElement.textContent = riskScore.score;
            riskScoreDiv.className = `risk-score risk-${riskScore.level}`;

            // Auth status (simulated - ger√ßek implementasyonda SPF/DKIM kontrol√º yapƒ±lacak)
            const authStatusDiv = document.getElementById('authStatus');
            authStatusDiv.innerHTML = `
                <div class="auth-item auth-none">SPF: N/A</div>
                <div class="auth-item auth-none">DKIM: N/A</div>
                <div class="auth-item auth-none">DMARC: N/A</div>
            `;

            // URL sonu√ßlarƒ±
            const urlResultsDiv = document.getElementById('urlResults');
            if (urlResults.length === 0) {
                urlResultsDiv.innerHTML = '<p>Bu e-postada URL bulunamadƒ±.</p>';
            } else {
                urlResultsDiv.innerHTML = urlResults.map(result => {
                    const positives = result.virusTotal ? result.virusTotal.positives : 0;
                    const total = result.virusTotal ? result.virusTotal.total : 0;
                    const hasNote = result.virusTotal && result.virusTotal.note;
                    const shortUrl = result.url.length > 60 ? result.url.substring(0, 60) + '...' : result.url;
                    
                    return `
                        <div class="url-item ${result.riskLevel === 'high' ? 'threat-detected' : result.riskLevel === 'medium' ? 'threat-detected' : 'threat-clean'}">
                            <strong>üîó ${shortUrl}</strong>
                            ${result.virusTotal ? `
                                <span class="threat-score" style="background-color: ${result.riskLevel === 'high' ? '#e74c3c' : result.riskLevel === 'medium' ? '#f39c12' : '#27ae60'}; color: white;">
                                    ${positives}/${total} pozitif
                                </span>
                                ${hasNote ? `<br><small style="color: #7f8c8d; margin-top: 5px; display: block;">üîπ ${result.virusTotal.note}</small>` : ''}
                                ${positives > 0 ? `<br><small style="color: #e74c3c; font-weight: bold; margin-top: 5px; display: block;">‚ö†Ô∏è Bu URL ${positives} g√ºvenlik motoru tarafƒ±ndan tehlikeli olarak i≈üaretlenmi≈ü!</small>` : ''}
                            ` : ''}
                            ${result.error ? `<p style="color: #e74c3c;">Hata: ${result.error}</p>` : ''}
                        </div>
                    `;
                }).join('');
            }

            // Attachment sonu√ßlarƒ±
            const attachmentResultsDiv = document.getElementById('attachmentResults');
            if (attachmentResults.length === 0) {
                attachmentResultsDiv.innerHTML = '<p>Bu e-postada ek bulunamadƒ±.</p>';
            } else {
                attachmentResultsDiv.innerHTML = attachmentResults.map(att => `
                    <div class="attachment-item ${att.riskLevel === 'high' ? 'threat-detected' : att.riskLevel === 'medium' ? 'threat-detected' : 'threat-clean'}">
                        <strong>üìé ${att.name}</strong>
                        <span class="threat-score" style="background-color: ${att.riskLevel === 'high' ? '#e74c3c' : att.riskLevel === 'medium' ? '#f39c12' : '#27ae60'}; color: white;">
                            ${att.riskLevel.toUpperCase()} Rƒ∞SK
                        </span>
                        <p>Boyut: ${att.size ? Math.round(att.size / 1024) + ' KB' : 'Bilinmiyor'}</p>
                    </div>
                `).join('');
            }

            // Risk fakt√∂rleri
            const riskFactorsDiv = document.getElementById('riskFactors');
            if (riskScore.factors.length === 0) {
                riskFactorsDiv.innerHTML = '<div class="no-risks">‚úÖ Belirgin risk fakt√∂r√º bulunamadƒ±</div>';
            } else {
                riskFactorsDiv.innerHTML = `
                    <div class="risk-factors">
                        <ul>
                            ${riskScore.factors.map(factor => `<li>${factor}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
        }

        function showError(message) {
            document.getElementById('results').innerHTML = `
                <div class="error">
                    <strong>‚ùå Hata:</strong> ${message}
                </div>
            `;
            document.getElementById('results').style.display = 'block';
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
    </script>
</body>
</html>